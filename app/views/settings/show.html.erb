<% content_for :title, "Settings" %>

<%
  account_list = ListGroupComponent.new.tap do |list|
    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Email",
      value: tag.span(class: "flex items-center gap-2") {
        safe_join([
          @user.email_address,
          link_to("Change", edit_settings_email_update_path, class: "ff-link text-sm")
        ])
      },
      key: "settings.email"
    ))

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Password",
      value: tag.span(class: "flex items-center gap-2") {
        safe_join([
          "Last updated #{time_ago_in_words(@user.password_updated_at || @user.created_at)} ago",
          link_to("Change", edit_settings_password_update_path, class: "ff-link text-sm")
        ])
      },
      key: "settings.password"
    ))

    if @user.permissions.any?
      list.with_item(ListGroupComponent::StatItemComponent.new(
        label: "Permissions",
        value: @user.permissions.map { |permission| permission.name.humanize }.join(", "),
        key: "settings.permissions"
      ))
    end
  end

  tokens_value = if @access_tokens.any?
    active_count = @access_tokens.active.count
    inactive_count = @access_tokens.inactive.count
    parts = ["#{active_count} active"]
    parts << "#{inactive_count} inactive" if inactive_count > 0
    tag.span(class: "flex items-center gap-2") {
      safe_join([
        parts.join(", "),
        link_to("Manage", settings_access_tokens_path, class: "ff-link text-sm")
      ])
    }
  else
    tag.span(class: "flex items-center gap-2") {
      safe_join([
        "None configured",
        link_to("Add a token", new_settings_access_token_path, class: "ff-link text-sm")
      ])
    }
  end

  tokens_list = ListGroupComponent.new.tap do |list|
    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Tokens",
      value: tokens_value,
      key: "settings.tokens"
    ))
  end

  created_count = @user.created_invites.count
  used_count = @user.created_invites.where.not(invited_user_id: nil).count
  invites_parts = ["#{@user.available_invites} available"]
  invites_parts << "#{created_count} created" if created_count > 0
  invites_parts << "#{used_count} used" if used_count > 0

  invites_value = if @user.available_invites > 0 || created_count > 0
    link_text = @user.available_invites > 0 ? "Invite someone" : "See your invites"
    tag.span(class: "flex items-center gap-2") {
      safe_join([
        invites_parts.join(", "),
        link_to(link_text, invites_path, class: "ff-link text-sm")
      ])
    }
  else
    invites_parts.join(", ")
  end

  invites_list = ListGroupComponent.new.tap do |list|
    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Invites",
      value: invites_value,
      key: "settings.invites"
    ))
  end
%>

<div class="space-y-8">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
    <h1 class="ff-h1">Settings</h1>
    <%= link_to "Sign Out", session_path, data: { turbo_method: :delete }, class: class_names("ff-button", "ff-button--secondary", "ff-button--compact") %>
  </div>

  <section class="space-y-4">
    <h2 class="ff-h2">Your Account</h2>
    <%= render(account_list) %>
  </section>

  <section class="space-y-4">
    <h2 class="ff-h2">Freefeed Application Tokens</h2>
    <%= render(tokens_list) %>
  </section>

  <section class="space-y-4">
    <h2 class="ff-h2">Feeder Invites</h2>
    <%= render(invites_list) %>
  </section>
</div>
