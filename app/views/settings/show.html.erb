<% content_for :title, "Settings" %>

<%
  account_list = ListGroupComponent.new.tap do |list|
    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Email",
      value: tag.span(class: "flex items-center gap-2") {
        safe_join([
          @user.email_address,
          link_to("Change", edit_settings_email_update_path, class: "ff-link text-sm")
        ])
      },
      key: "settings.email"
    ))

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Password",
      value: tag.span(class: "flex items-center gap-2") {
        safe_join([
          "Last updated #{time_ago_in_words(@user.password_updated_at || @user.created_at)} ago",
          link_to("Change", edit_settings_password_update_path, class: "ff-link text-sm")
        ])
      },
      key: "settings.password"
    ))

    if @user.permissions.any?
      list.with_item(ListGroupComponent::StatItemComponent.new(
        label: "Permissions",
        value: @user.permissions.map { |permission| permission.name.humanize }.join(", "),
        key: "settings.permissions"
      ))
    end
  end

  active_count = @access_tokens.active.count
  inactive_count = @access_tokens.inactive.count

  created_count = @user.created_invites.count
  used_count = @user.created_invites.where.not(invited_user_id: nil).count
%>

<div class="space-y-8">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
    <h1 class="ff-h1">Settings</h1>
    <%= link_to "Sign Out", session_path, data: { turbo_method: :delete }, class: class_names("ff-button", "ff-button--secondary", "ff-button--compact") %>
  </div>

  <section class="space-y-4">
    <h2 class="ff-h2">Your Account</h2>
    <%= render(account_list) %>
  </section>

  <section class="space-y-4">
    <h2 class="ff-h2">FreeFeed Application Tokens</h2>
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
      <div class="space-y-2">
        <p class="ff-text text-slate-600">
          Tokens allow Feeder to post content to FreeFeed on your behalf.
        </p>
        <% if @access_tokens.any? %>
          <p class="ff-text text-slate-600">
            You have <%= pluralize(active_count, 'active token') %><% if inactive_count > 0 %> and <%= pluralize(inactive_count, 'inactive token') %><% end %>.
          </p>
        <% else %>
          <p class="ff-text text-slate-600">
            You don't have any FreeFeed tokens configured yet.
          </p>
        <% end %>
      </div>
      <div class="shrink-0">
        <% if @access_tokens.any? %>
          <%= link_to "Manage", settings_access_tokens_path, class: class_names("ff-button", "ff-button--compact", "ff-button--secondary") %>
        <% else %>
          <%= link_to "Add Token", new_settings_access_token_path, class: class_names("ff-button", "ff-button--compact") %>
        <% end %>
      </div>
    </div>
  </section>

  <section class="space-y-4">
    <h2 class="ff-h2">Feeder Invites</h2>
    <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
      <div class="space-y-2">
        <p class="ff-text text-slate-600">
          Invites let you add new users to Feeder.
        </p>
        <% if @user.available_invites > 0 %>
          <p class="ff-text text-slate-600">
            You have <%= pluralize(@user.available_invites, 'invite') %> available<% if created_count > 0 %>, <%= pluralize(created_count, 'created') %><% end %><% if used_count > 0 %>, and <%= pluralize(used_count, 'used') %><% end %>.
          </p>
        <% elsif created_count > 0 %>
          <p class="ff-text text-slate-600">
            You have <%= pluralize(created_count, 'invite') %> created<% if used_count > 0 %>, <%= pluralize(used_count, 'used') %><% end %>.
          </p>
        <% else %>
          <p class="ff-text text-slate-600">
            You don't have any invites available right now.
          </p>
        <% end %>
      </div>
      <div class="shrink-0">
        <% if @user.available_invites > 0 %>
          <%= link_to "Invite Someone", invites_path, class: class_names("ff-button", "ff-button--compact") %>
        <% elsif created_count > 0 %>
          <%= link_to "View Invites", invites_path, class: class_names("ff-button", "ff-button--compact", "ff-button--secondary") %>
        <% end %>
      </div>
    </div>
  </section>
</div>
