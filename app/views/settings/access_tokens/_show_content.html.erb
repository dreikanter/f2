<%= render PageHeaderComponent.new(title: @access_token.name) do |header| %>
  <% unless @access_token.pending? || @access_token.validating? %>
    <% header.with_action_button do %>
      <%= link_to "Back to Tokens", settings_access_tokens_path, class: class_names("ff-button", "ff-button--secondary", "ff-button--compact") %>
    <% end %>

    <% header.with_action_button do %>
      <%= link_to "Delete",
                  "#",
                  class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                  data: { controller: "modal-trigger", modal_trigger_modal_id_value: "delete-token-modal", action: "click->modal-trigger#open" } %>
    <% end %>
  <% end %>
<% end %>

<%= render ConfirmationModalComponent.new(
  title: "Delete Access Token",
  action: "Delete token",
  url: settings_access_token_path(@access_token),
  method: :delete,
  modal_id: "delete-token-modal"
) do %>
  <div class="ff-alert ff-alert--warning space-y-2">
    <p>The token <em><%= @access_token.name %></em> will be permanently removed.</p>
    <p>Any feeds using this token will be automatically disabled.</p>
    <p>This can't be undone.</p>
  </div>
<% end %>

<% if @access_token.pending? || @access_token.validating? %>
  <div
    data-controller="polling"
    data-polling-endpoint-value="<%= settings_access_token_validation_path(@access_token) %>"
    data-polling-interval-value="2000"
    data-polling-stop-condition-value="data-status"
    aria-busy="true"
    class="ff-card">
    <div class="ff-card__body">
      <div class="flex items-center justify-center py-8">
        <%= render SpinnerComponent.new(css_class: "mr-3") %>
        <span class="text-lg text-slate-600">Validating token...</span>
      </div>
    </div>
  </div>
<% elsif @access_token.active? %>
  <div class="ff-alert ff-alert--success" data-status="active">
    <%= icon("check-circle", aria_hidden: true) %>
    <span>Token is valid and ready to use</span>
  </div>

  <%= render TokenDetailsComponent.new(access_token: @access_token) %>

  <div class="space-y-4">
    <h2 class="ff-h2">Publisher</h2>
    <p class="text-slate-600 mb-4">
      Posts created with this token will appear on FreeFeed on behalf of:
    </p>
    <%= render FreefeedUserComponent.new(username: @access_token.owner) %>
  </div>

  <% if @access_token.access_token_detail.present? %>
    <% managed_groups = @access_token.access_token_detail.managed_groups %>
    <div class="space-y-4">
      <h2 class="ff-h2">FreeFeed Groups</h2>
      <% if managed_groups.any? %>
        <p><%= pluralize(managed_groups.count, "groups") %> available for posting:</p>
        <ul class="list-disc list-inside">
          <% managed_groups.sort_by { _1["username"] }.each do |group| %>
            <li><%= link_to group["username"], "#{@access_token.host}/#{group["username"]}", target: "_blank", rel: "noopener noreferrer", class: "ff-link" %></li>
          <% end %>
        </ul>
      <% else %>
        <%= render EmptyStateComponent.new do %>
          <p class="">No groups available for posting.</p>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <div class="space-y-4">
    <h2 class="ff-h2">Associated Feeds</h2>
    <% if @access_token.feeds.any? %>
      <%= render FeedsListComponent.new(feeds: @access_token.feeds) %>
    <% else %>
      <%= render EmptyStateComponent.new do %>
        <p class="">No associated feeds yet.</p>
      <% end %>
    <% end %>
  </div>
<% elsif @access_token.inactive? %>
  <div class="ff-alert ff-alert--error" data-status="inactive">
    <%= icon("x-circle", aria_hidden: true) %>
    <span>Token is inactive and cannot be used to access FreeFeed API. This token failed validation. It may be expired, revoked, or incorrectly copied.</span>
  </div>

  <%= render TokenDetailsComponent.new(access_token: @access_token) %>
<% end %>
