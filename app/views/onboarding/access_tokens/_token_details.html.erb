<%
  host ||= AccessToken::FREEFEED_HOSTS[:production][:url]
  token ||= ""
  user_info ||= {}
  managed_groups ||= []
%>

<%= form_with url: onboarding_access_token_path, method: :post do |form| %>
  <%= form.hidden_field :host, value: host %>
  <%= form.hidden_field :token, value: token %>
  <%= form.hidden_field :owner, value: user_info[:username] %>

  <div class="mb-3">
    <%= form.label :host, "FreeFeed Instance", class: "form-label fw-bold" %>
    <%= form.select :host,
      options_for_select(AccessToken.host_options_for_select, host),
      {},
      class: "form-select",
      disabled: true %>
  </div>

  <div class="mb-3">
    <%= form.label :token, "API Token", class: "form-label fw-bold" %>
    <%= form.password_field :token, value: token, class: "form-control", disabled: true %>
  </div>

  <div class="mb-3">
    <%= form.label :owner, "Posting As", class: "form-label fw-bold" %>
    <%= form.text_field :owner, value: user_info[:username], class: "form-control", disabled: true %>
    <div class="form-text">Posts will be created by this user</div>
  </div>

  <% if managed_groups.any? %>
    <div class="mb-3">
      <label class="form-label fw-bold">Groups Available for Posting</label>
      <ul class="list-unstyled">
        <% managed_groups.each do |group| %>
          <li class="mb-1">
            <%= link_to "@#{group[:username]}", "#{host}/#{group[:username]}", target: "_blank", class: "text-decoration-none" %>
            <%= " (#{group[:screen_name]})" if group[:screen_name].present? && group[:screen_name] != group[:username] %>
            <% if group[:is_private] %>
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-lock-fill text-muted ms-1" viewBox="0 0 16 16" style="margin-bottom: 2px;">
                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2"/>
              </svg>
            <% end %>
          </li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <% if validation_error.present? %>
    <div class="alert alert-danger" role="alert">
      <%= validation_error %>
    </div>
  <% end %>

  <div class="d-flex gap-3">
    <%= link_to "Back", onboarding_access_token_path, class: "btn btn-light" %>
    <%= form.submit "Save token and continue", class: "btn btn-primary" %>
  </div>
<% end %>
