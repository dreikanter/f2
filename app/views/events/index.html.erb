<% content_for :title, "Events" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Events</h1>
  <div class="text-muted">
    <%= pluralize(@total_count, 'event') %> total
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Type</th>
            <th>Level</th>
            <th>Message</th>
            <th>User</th>
            <th>Subject</th>
            <th>Created</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% @events.each do |event| %>
            <tr>
              <td>
                <code class="text-dark"><%= event.type %></code>
              </td>
              <td>
                <span class="badge bg-<%= level_badge_class(event.level) %>">
                  <%= event.level.humanize %>
                </span>
              </td>
              <td>
                <div class="text-truncate" style="max-width: 300px;">
                  <%= event.message.present? ? event.message : content_tag(:em, "No message", class: "text-muted") %>
                </div>
              </td>
              <td>
                <%= event.user&.email_address || content_tag(:em, "System", class: "text-muted") %>
              </td>
              <td>
                <% if event.subject %>
                  <span class="text-muted"><%= event.subject_type %></span>
                  <span class="text-primary">#<%= event.subject_id %></span>
                <% else %>
                  <em class="text-muted">None</em>
                <% end %>
              </td>
              <td>
                <span title="<%= event.created_at.iso8601 %>">
                  <%= time_ago_in_words(event.created_at) %> ago
                </span>
              </td>
              <td>
                <%= link_to "View", event_path(event), class: "btn btn-sm btn-outline-primary" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<% if @total_pages > 1 %>
  <nav aria-label="Events pagination" class="mt-4">
    <ul class="pagination justify-content-center">
      <% if @current_page > 1 %>
        <li class="page-item">
          <%= link_to "Previous", events_path(page: @current_page - 1), class: "page-link" %>
        </li>
      <% else %>
        <li class="page-item disabled">
          <span class="page-link">Previous</span>
        </li>
      <% end %>

      <% page_start = [@current_page - 2, 1].max %>
      <% page_end = [page_start + 4, @total_pages].min %>
      <% page_start = [page_end - 4, 1].max if page_end - page_start < 4 %>

      <% (page_start..page_end).each do |page| %>
        <% if page == @current_page %>
          <li class="page-item active">
            <span class="page-link"><%= page %></span>
          </li>
        <% else %>
          <li class="page-item">
            <%= link_to page, events_path(page: page), class: "page-link" %>
          </li>
        <% end %>
      <% end %>

      <% if @current_page < @total_pages %>
        <li class="page-item">
          <%= link_to "Next", events_path(page: @current_page + 1), class: "page-link" %>
        </li>
      <% else %>
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
      <% end %>
    </ul>

    <div class="text-center text-muted">
      Showing <%= @events.size %> of <%= @total_count %> events
      (Page <%= @current_page %> of <%= @total_pages %>)
    </div>
  </nav>
<% end %>

<% if @events.empty? %>
  <div class="text-center py-5 text-muted">
    <h4>No events found</h4>
    <p>Events will appear here as they are created.</p>
  </div>
<% end %>