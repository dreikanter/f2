<%= page_header @user.email_address do %>
  <%= link_to "Back to Users", admin_users_path, class: "btn btn-outline-secondary" %>
<% end %>

<div class="list-group">
  <div class="list-group-item">
    <strong>Email:</strong> <%= @user.email_address %>
  </div>

  <div class="list-group-item">
    <strong>Permissions:</strong>
    <% if @user.permissions.any? %>
      <%= @user.permissions.pluck(:name).join(", ") %>
    <% else %>
      <span class="text-muted">None</span>
    <% end %>
  </div>

  <div class="list-group-item">
    <strong>Created:</strong>
    <time datetime="<%= @user.created_at.iso8601 %>" title="<%= @user.created_at.to_fs(:long) %>">
      <%= @user.created_at.to_date.to_fs(:long) %> (<%= short_time_ago(@user.created_at) %>)
    </time>
  </div>

  <div class="list-group-item">
    <strong>Updated:</strong>
    <time datetime="<%= @user.updated_at.iso8601 %>" title="<%= @user.updated_at.to_fs(:long) %>">
      <%= @user.updated_at.to_date.to_fs(:long) %> (<%= short_time_ago(@user.updated_at) %>)
    </time>
  </div>

  <div class="list-group-item">
    <strong>Password Updated:</strong>
    <% if @user.password_updated_at.present? %>
      <time datetime="<%= @user.password_updated_at.iso8601 %>" title="<%= @user.password_updated_at.to_fs(:long) %>">
        <%= @user.password_updated_at.to_date.to_fs(:long) %> (<%= short_time_ago(@user.password_updated_at) %>)
      </time>
    <% else %>
      <span class="text-muted">Never</span>
    <% end %>
  </div>

  <div class="list-group-item">
    <strong>Last Seen:</strong>
    <% last_session = @user.sessions.order(updated_at: :desc).first %>
    <% if last_session %>
      <time datetime="<%= last_session.updated_at.iso8601 %>" title="<%= last_session.updated_at.to_fs(:long) %>">
        <%= last_session.updated_at.to_date.to_fs(:long) %> (<%= short_time_ago(last_session.updated_at) %>)
      </time>
    <% else %>
      <span class="text-muted">Never</span>
    <% end %>
  </div>
</div>

<% if @user.email_deactivated? %>
  <%= page_section_header "Email Status" %>

  <div class="list-group">
    <div class="list-group-item">
      <strong>Status:</strong> <span class="badge bg-warning text-dark">Deactivated</span>
    </div>

    <div class="list-group-item">
      <strong>Deactivated At:</strong>
      <time datetime="<%= @user.email_deactivated_at.iso8601 %>" title="<%= @user.email_deactivated_at.to_fs(:long) %>">
        <%= @user.email_deactivated_at.to_date.to_fs(:long) %> (<%= short_time_ago(@user.email_deactivated_at) %>)
      </time>
    </div>

    <div class="list-group-item">
      <strong>Reason:</strong> <%= @user.email_deactivation_reason.humanize %>
    </div>

    <div class="list-group-item">
      <strong>Actions:</strong>
      <%= button_to "Reactivate Email", admin_user_email_reactivation_path(@user), method: :post, class: "btn btn-sm btn-primary" %>
      <%= link_to "View Email Events", admin_events_path(filter: { user_id: @user.id, type: %w[EmailBouncedEvent EmailComplainedEvent EmailFailedEvent EmailSentEvent EmailDeliveredEvent EmailDelayedEvent EmailOpenedEvent EmailClickedEvent EmailChangedEvent] }), class: "btn btn-sm btn-secondary" %>
    </div>
  </div>
<% end %>

<%= page_section_header "Statistics" %>

<div class="list-group">
  <div class="list-group-item">
    <strong>Feeds:</strong>
    <%= @user.feeds.count %> total
    (<%= @user.feeds.enabled.count %> enabled,
    <%= @user.feeds.disabled.count %> disabled)
  </div>

  <div class="list-group-item">
    <strong>Access Tokens:</strong>
    <%= @user.access_tokens.count %> total
    (<%= @user.access_tokens.where(status: "active").count %> active,
    <%= @user.access_tokens.where.not(status: "active").count %> not active)
  </div>

  <div class="list-group-item">
    <strong>Posts:</strong> <%= Post.joins(:feed).where(feeds: { user_id: @user.id }).count %>
  </div>

  <div class="list-group-item">
    <strong>Most Recent Post:</strong>
    <% most_recent_post = Post.joins(:feed).where(feeds: { user_id: @user.id }).order(published_at: :desc).first %>
    <% if most_recent_post %>
      <time datetime="<%= most_recent_post.published_at.iso8601 %>" title="<%= most_recent_post.published_at.to_fs(:long) %>">
        <%= most_recent_post.published_at.to_date.to_fs(:long) %> (<%= short_time_ago(most_recent_post.published_at) %>)
      </time>
    <% else %>
      <span class="text-muted">No posts yet</span>
    <% end %>
  </div>
</div>

<%= page_section_header "Invitations" %>

<div class="list-group mb-3">
  <div class="list-group-item">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <strong>Available Invites:</strong>
        <%= @user.available_invites %>
      </div>
      <div>
        <%= form_with model: @user, url: admin_user_available_invites_path(@user), method: :patch, class: "d-flex gap-2 align-items-center", data: { turbo_frame: "_top" } do |form| %>
          <%= form.number_field :available_invites, min: 0, class: "form-control form-control-sm", style: "width: 100px;" %>
          <%= form.submit "Update", class: "btn btn-sm btn-primary" %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="list-group">
  <div class="list-group-item">
    <strong>Created Invites:</strong> <%= @user.created_invites.count %>
  </div>

  <div class="list-group-item">
    <strong>Invited Users:</strong> <%= @user.created_invites.where.not(invited_user_id: nil).count %>
  </div>
</div>

<% invited_users = @user.created_invites.includes(:invited_user).where.not(invited_user_id: nil).order(created_at: :desc) %>
<% if invited_users.any? %>
  <h4 class="mt-3 mb-3">Users Invited by <%= @user.name %></h4>
  <div class="table-responsive">
    <table class="table table-hover table-bordered">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Invited</th>
        </tr>
      </thead>
      <tbody>
        <% invited_users.each do |invite| %>
          <tr>
            <td><%= link_to invite.invited_user.name, admin_user_path(invite.invited_user), class: "text-decoration-none" %></td>
            <td><%= invite.invited_user.email_address %></td>
            <td><%= short_time_ago(invite.created_at) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<%= page_section_header "Active Sessions" %>

<% if @user.sessions.any? %>
  <div class="table-responsive">
    <table class="table table-hover table-bordered text-nowrap">
      <thead>
        <tr>
          <th>IP Address</th>
          <th>User Agent</th>
          <th class="text-center">Created</th>
          <th class="text-center">Last Seen</th>
        </tr>
      </thead>
      <tbody>
        <% @user.sessions.order(updated_at: :desc).each do |session| %>
          <tr>
            <td><%= session.ip_address %></td>
            <td class="text-truncate" style="max-width: 300px;"><%= session.user_agent %></td>
            <td class="text-center">
              <time class="text-muted" datetime="<%= session.created_at.iso8601 %>" title="<%= session.created_at.to_fs(:long) %>">
                <%= short_time_ago(session.created_at) %>
              </time>
            </td>
            <td class="text-center">
              <time class="text-muted" datetime="<%= session.updated_at.iso8601 %>" title="<%= session.updated_at.to_fs(:long) %>">
                <%= short_time_ago(session.updated_at) %>
              </time>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <p class="text-muted">No active sessions</p>
<% end %>

<%= page_section_header "Actions" %>

<div class="d-flex gap-2">
  <%= link_to "Change Email", edit_admin_user_email_update_path(@user), class: "btn btn-outline-secondary" %>
  <%= link_to "Reset Password", admin_user_password_reset_path(@user), class: "btn btn-outline-secondary" %>
</div>

<%= page_section_header "Danger Zone" %>

<% if @user.suspended? %>
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Restore User Access</h5>
      <p class="card-text">
        User suspended on
        <time datetime="<%= @user.suspended_at.iso8601 %>" title="<%= @user.suspended_at.to_fs(:long) %>">
          <%= @user.suspended_at.to_date.to_fs(:long) %>
        </time>.
        Restores ability to sign in and access feeds.
      </p>
      <%= button_to "Unsuspend user", admin_user_suspension_path(@user), method: :delete, class: "btn btn-outline-secondary", data: { turbo_confirm: "Are you sure you want to unsuspend this user?" } %>
    </div>
  </div>
<% else %>
  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Suspend User Account</h5>
      <p class="card-text">Terminates all active sessions, disables all feeds, and prevents sign in.</p>
      <%= button_to "Suspend user", admin_user_suspension_path(@user), method: :post, class: "btn btn-outline-danger", data: { turbo_confirm: "Are you sure you want to suspend this user? All active sessions will be terminated and feeds will be disabled." } %>
    </div>
  </div>
<% end %>
