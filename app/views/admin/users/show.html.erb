<% content_for :title, @user.email_address %>

<%
  # TBD: Extract higher-level components
  user_info = ListGroupComponent.new.tap do |list|
    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Email",
      value: @user.email_address
    ))

    permissions_value = if @user.permissions.any?
      @user.permissions.pluck(:name).join(", ")
    else
      tag.span("None", class: "text-slate-500")
    end

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Permissions",
      value: permissions_value
    ))

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Created",
      value: tag.time(
        "#{@user.created_at.to_date.to_fs(:long)} (#{short_time_ago(@user.created_at)})",
        datetime: @user.created_at.iso8601,
        title: @user.created_at.to_fs(:long)
      )
    ))

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Updated",
      value: tag.time(
        "#{@user.updated_at.to_date.to_fs(:long)} (#{short_time_ago(@user.updated_at)})",
        datetime: @user.updated_at.iso8601,
        title: @user.updated_at.to_fs(:long)
      )
    ))

    password_updated_value = if @user.password_updated_at.present?
      tag.time(
        "#{@user.password_updated_at.to_date.to_fs(:long)} (#{short_time_ago(@user.password_updated_at)})",
        datetime: @user.password_updated_at.iso8601,
        title: @user.password_updated_at.to_fs(:long)
      )
    else
      tag.span("Never", class: "text-slate-500")
    end

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Password Updated",
      value: password_updated_value
    ))

    last_seen_value = if @stats.last_session
      tag.time(
        "#{@stats.last_session.updated_at.to_date.to_fs(:long)} (#{short_time_ago(@stats.last_session.updated_at)})",
        datetime: @stats.last_session.updated_at.iso8601,
        title: @stats.last_session.updated_at.to_fs(:long)
      )
    else
      tag.span("Never", class: "text-slate-500")
    end

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Last Seen",
      value: last_seen_value
    ))
  end

  email_status_list = if @user.email_deactivated?
    ListGroupComponent.new.tap do |list|
      list.with_item(ListGroupComponent::StatItemComponent.new(
        label: "Status",
        value: tag.span("Deactivated", class: "inline-flex items-center rounded-md bg-amber-50 px-2 py-1 text-xs font-medium text-amber-700 ring-1 ring-inset ring-amber-600/20")
      ))

      list.with_item(ListGroupComponent::StatItemComponent.new(
        label: "Deactivated At",
        value: tag.time(
          "#{@user.email_deactivated_at.to_date.to_fs(:long)} (#{short_time_ago(@user.email_deactivated_at)})",
          datetime: @user.email_deactivated_at.iso8601,
          title: @user.email_deactivated_at.to_fs(:long)
        )
      ))

      list.with_item(ListGroupComponent::StatItemComponent.new(
        label: "Reason",
        value: @user.email_deactivation_reason.humanize
      ))

      list.with_item(ListGroupComponent::StatItemComponent.new(
        label: "Actions",
        value: safe_join([
          button_to("Reactivate Email", admin_user_email_reactivation_path(@user), method: :post, class: "ff-button ff-button--compact"),
          link_to("View Email Events", admin_events_path(filter: { user_id: @user.id, type: mail_event_types }), class: "ff-button ff-button--secondary ff-button--compact")
        ], " ")
      ))
    end
  end

  stats_list = ListGroupComponent.new.tap do |list|
    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Feeds",
      value: "#{@stats.feeds_count} total (#{@stats.feeds_enabled_count} enabled, #{@stats.feeds_disabled_count} disabled)"
    ))

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Access Tokens",
      value: "#{@stats.access_tokens_count} total (#{@stats.active_access_tokens_count} active, #{@stats.inactive_access_tokens_count} not active)"
    ))

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Posts",
      value: @stats.posts_count
    ))

    most_recent_post_value = if @stats.most_recent_post
      tag.time(
        "#{@stats.most_recent_post.published_at.to_date.to_fs(:long)} (#{short_time_ago(@stats.most_recent_post.published_at)})",
        datetime: @stats.most_recent_post.published_at.iso8601,
        title: @stats.most_recent_post.published_at.to_fs(:long)
      )
    else
      tag.span("No posts yet", class: "text-slate-500")
    end

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Most Recent Post",
      value: most_recent_post_value
    ))
  end

  invitations_list = ListGroupComponent.new.tap do |list|
    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Available Invites",
      value: form_with(model: @user, url: admin_user_available_invites_path(@user), method: :patch, class: "flex gap-2 items-center", data: { turbo_frame: "_top" }) do |form|
        safe_join([
          tag.span(@user.available_invites, class: "font-semibold"),
          form.number_field(:available_invites, min: 0, class: "rounded-md border border-slate-300 px-2 py-1 text-sm w-20"),
          form.submit("Update", class: "ff-button ff-button--compact text-sm px-3 py-1")
        ], " ")
      end
    ))

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Created Invites",
      value: @stats.created_invites_count
    ))

    list.with_item(ListGroupComponent::StatItemComponent.new(
      label: "Invited Users",
      value: @stats.invited_users_count
    ))
  end
%>

<div class="space-y-8">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
    <h1 class="ff-h1"><%= @user.email_address %></h1>
    <%= link_to "Back to Users", admin_users_path, class: class_names("ff-button", "ff-button--secondary", "ff-button--compact") %>
  </div>

  <%= render(user_info) %>

  <% if @user.email_deactivated? %>
    <section class="space-y-4">
      <h2 class="ff-h2">Email Status</h2>
      <%= render(email_status_list) %>
    </section>
  <% end %>

  <section class="space-y-4">
    <h2 class="ff-h2">Statistics</h2>
    <%= render(stats_list) %>
  </section>

  <section class="space-y-4">
    <h2 class="ff-h2">Invitations</h2>
    <%= render(invitations_list) %>
  </section>

  <% if @stats.invited_users.any? %>
    <section class="space-y-4">
      <h3 class="ff-h3">Users Invited by <%= @user.name %></h3>
      <div class="ff-table-container">
        <table class="ff-table">
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Email</th>
              <th scope="col">Invited</th>
            </tr>
          </thead>
          <tbody>
            <% @stats.invited_users.each do |invite| %>
              <tr>
                <td><%= link_to invite.invited_user.name, admin_user_path(invite.invited_user), class: "ff-link" %></td>
                <td><%= invite.invited_user.email_address %></td>
                <td><%= short_time_ago(invite.created_at) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </section>
  <% end %>

  <section class="space-y-4">
    <h2 class="ff-h2">Active Sessions</h2>

    <% if @stats.sessions.any? %>
      <div class="ff-table-container">
        <table class="ff-table">
          <thead>
            <tr>
              <th scope="col">IP Address</th>
              <th scope="col">User Agent</th>
              <th scope="col" class="text-center">Created</th>
              <th scope="col" class="text-center">Last Seen</th>
            </tr>
          </thead>
          <tbody>
            <% @stats.sessions.each do |session| %>
              <tr>
                <td><%= session.ip_address %></td>
                <td class="max-w-md">
                  <div class="truncate"><%= session.user_agent %></div>
                </td>
                <td class="text-center">
                  <time class="text-slate-500" datetime="<%= session.created_at.iso8601 %>" title="<%= session.created_at.to_fs(:long) %>">
                    <%= short_time_ago(session.created_at) %>
                  </time>
                </td>
                <td class="text-center">
                  <time class="text-slate-500" datetime="<%= session.updated_at.iso8601 %>" title="<%= session.updated_at.to_fs(:long) %>">
                    <%= short_time_ago(session.updated_at) %>
                  </time>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="text-slate-500">No active sessions</p>
    <% end %>
  </section>

  <section class="space-y-4">
    <h2 class="ff-h2">Actions</h2>
    <div class="flex gap-2">
      <%= link_to "Change Email", edit_admin_user_email_update_path(@user), class: "ff-button ff-button--secondary ff-button--compact" %>
      <%= link_to "Reset Password", "#", class: "ff-button ff-button--secondary ff-button--compact", data: { controller: "modal-trigger", modal_trigger_modal_id_value: "password-reset-modal-#{@user.id}", action: "click->modal-trigger#open" } %>
      <% if @user.suspended? %>
        <%= link_to "Unsuspend user", "#", class: "ff-button ff-button--secondary ff-button--compact", data: { controller: "modal-trigger", modal_trigger_modal_id_value: "unsuspend-user-modal-#{@user.id}", action: "click->modal-trigger#open" } %>
      <% else %>
        <%= link_to "Suspend user", "#", class: "ff-button ff-button--secondary ff-button--compact", data: { controller: "modal-trigger", modal_trigger_modal_id_value: "suspend-user-modal-#{@user.id}", action: "click->modal-trigger#open" } %>
      <% end %>
    </div>
  </section>
</div>

<%= render ConfirmationModalComponent.new(
  title: "Reset Password for #{@user.email_address}",
  action: "Send Password Reset Email",
  url: admin_user_password_reset_path(@user),
  method: :post,
  modal_id: "password-reset-modal-#{@user.id}"
) do %>
  <p>This will send a password reset email to the user's current email address. The user will receive a link to set a new password. This does not change the password directlyâ€”the user must complete the reset process by clicking the link.</p>
<% end %>

<% if @user.suspended? %>
  <%= render ConfirmationModalComponent.new(
    title: "Unsuspend User",
    action: "Unsuspend user",
    url: admin_user_suspension_path(@user),
    method: :delete,
    modal_id: "unsuspend-user-modal-#{@user.id}"
  ) do %>
    <p>This will restore <%= @user.email_address %>'s ability to sign in and access their account.</p>
  <% end %>
<% else %>
  <%= render ConfirmationModalComponent.new(
    title: "Suspend User",
    action: "Suspend user",
    url: admin_user_suspension_path(@user),
    method: :post,
    modal_id: "suspend-user-modal-#{@user.id}"
  ) do %>
    <p>All active sessions for <%= @user.email_address %> will be terminated, all feeds will be disabled, and the user will be unable to sign in. You can unsuspend this user later to restore access.</p>
  <% end %>
<% end %>
