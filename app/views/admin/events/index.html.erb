<% content_for :title, "Events" %>

<div class="space-y-8">
  <%= render PageHeaderComponent.new(title: "Events") do |header| %>
    <% if @filter.present? %>
      <% header.with_context_paragraph do %>
        <span class="text-sm text-slate-500" data-key="admin.events.filter-summary">
          <% filter_parts = [] %>
          <% @filter.to_h.each do |key, value| %>
            <% if value.is_a?(Array) %>
              <% filter_parts << "#{key}: #{value.join(', ')}" %>
            <% else %>
              <% filter_parts << "#{key}: #{value}" %>
            <% end %>
          <% end %>
          Filtering by <%= filter_parts.join(" â€¢ ") %>.
        </span>
      <% end %>
    <% end %>
    <% if @filter.present? %>
      <% header.with_action_button do %>
        <%= link_to "Reset Filter", admin_events_path, class: "ff-button ff-button--secondary ff-button--compact" %>
      <% end %>
    <% end %>
    <% header.with_action_button do %>
      <%= link_to "Back to Admin", admin_path, class: "ff-button ff-button--secondary ff-button--compact" %>
    <% end %>
  <% end %>

  <% if @events.any? %>
    <div class="ff-table-container">
      <table class="ff-table ff-table--dense" data-key="admin.events.table">
        <thead>
          <tr>
            <th scope="col">Event</th>
            <th scope="col">User</th>
            <th scope="col">Subject</th>
          </tr>
        </thead>
        <tbody>
          <% @events.each do |event| %>
            <tr>
              <td class="align-top">
                <div class="flex flex-col gap-1">
                  <div class="flex items-center gap-2">
                    <%= link_to admin_event_path(event),
                                class: "text-xs font-medium tracking-wide hover:text-slate-700",
                                title: event.created_at.rfc3339,
                                data: { key: "admin.events.timestamp" } do %>
                      <%= short_time_ago(event.created_at) %>
                    <% end %>
                    <%
                      level_key = (event.level.to_s.presence || "debug").downcase
                      level_badge_classes = {
                        "debug" => "bg-slate-200 text-slate-600",
                        "info" => "bg-blue-100 text-blue-700",
                        "warning" => "bg-amber-100 text-amber-700",
                        "error" => "bg-red-100 text-red-700"
                      }
                      badge_class = level_badge_classes.fetch(level_key, "bg-slate-200 text-slate-600")
                    %>
                    <span class="ff-event-level <%= badge_class %>" data-key="admin.events.level"><%= level_key.upcase %></span>
                    <%= link_to admin_events_path(filter: { type: [event.type] }), class: "font-semibold", title: "Filter by type: #{event.type}" do %>
                      <code class="text-sm" data-key="admin.events.type"><%= event.type %></code>
                    <% end %>
                  </div>
                  <div class="max-w-sm text-sm text-slate-600">
                    <div class="truncate">
                      <%= render EventDescriptionComponent.new(event: event) %>
                    </div>
                  </div>
                </div>
              </td>
              <td>
                <% if event.user_id.present? %>
                  <%= link_to "User ##{event.user_id}",
                              admin_events_path(filter: { user_id: event.user_id }),
                              class: "text-slate-600 hover:text-slate-800",
                              title: "Filter by user id: #{event.user_id}",
                              data: { key: "admin.events.user" } %>
                <% else %>
                  <em class="text-slate-500" data-key="admin.events.user">System</em>
                <% end %>
              </td>
              <td>
                <%
                  subject_link = if event.subject_type.present?
                    filter_params = { subject_type: event.subject_type }
                    filter_params[:subject_id] = event.subject_id if event.subject_id.present?
                    title_text = event.subject_id.present? ? "Filter by subject: #{event.subject_type} ##{event.subject_id}" : "Filter by subject type: #{event.subject_type}"
                    link_to admin_events_path(filter: filter_params),
                            class: "text-slate-600 hover:text-slate-800",
                            title: title_text do
                      event.subject_type
                    end
                  end
                %>
                <% if subject_link %>
                  <%= subject_link %>
                  <% if event.subject_id.present? %>
                    <span class="text-slate-500">#<%= event.subject_id %></span>
                  <% end %>
                <% else %>
                  <em class="text-slate-500">None</em>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div data-key="admin.events.pagination">
      <%= render_pagination { |pagination, params| admin_events_path(pagination.merge(@filter.present? ? { filter: @filter.to_h } : {})) } %>
    </div>
  <% else %>
    <div class="ff-card">
      <div class="ff-card__body text-center py-12">
        <h2 class="ff-h2">No events found</h2>
        <p class="ff-text">Events will appear here as they are created.</p>
      </div>
    </div>
  <% end %>
</div>
