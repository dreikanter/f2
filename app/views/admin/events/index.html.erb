<% content_for :title, "Events" %>

<%= page_header "Events" do %>
  <% if @filter.present? %>
    <%= link_to "Reset Filter", admin_events_path, class: "btn btn-outline-secondary btn-sm" %>
  <% end %>
<% end %>

<% if @events.any? %>
  <div class="table-responsive">
    <table class="table table-hover table-bordered">
      <thead>
        <tr>
          <th>Type</th>
          <th class="text-center">Lvl</th>
          <th>Message</th>
          <th>User</th>
          <th>Subject</th>
          <th class="text-center"><i class="bi bi-calendar-event"></i></th>
        </tr>
      </thead>
      <tbody>
        <% @events.each do |event| %>
          <tr>
            <td>
              <%= link_to admin_events_path(filter: { type: event.type }),
                          class: "text-decoration-none",
                          title: "Filter by type: #{event.type}" do %>
                <code><%= event.type %></code>
              <% end %>
            </td>
            <td class="text-center">
              <%= level_badge(event.level) %>
            </td>
            <td>
              <div class="text-truncate" style="max-width: 300px;">
                <%= event.message.present? ? event.message : content_tag(:em, "No message", class: "text-muted") %>
              </div>
            </td>
            <td>
              <%= event.user&.email_address || content_tag(:em, "System", class: "text-muted") %>
            </td>
            <td>
              <% if event.subject %>
                <%= link_to admin_events_path(filter: { subject_type: event.subject_type }),
                            class: "text-decoration-none text-muted",
                            title: "Filter by subject type: #{event.subject_type}" do %>
                  <%= event.subject_type %>
                <% end %>
                <span class="text-primary">#<%= event.subject_id %></span>
              <% else %>
                <em class="text-muted">None</em>
              <% end %>
            </td>
            <td class="text-center">
              <span class="text-muted" title="<%= event.created_at.rfc3339 %>">
                <%= compact_time_ago(event.created_at) %>
              </span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% if pagination_total_pages > 1 %>
    <nav aria-label="Events pagination" class="mt-4">
      <ul class="pagination justify-content-center">
        <% if pagination_current_page > 1 %>
          <li class="page-item">
            <%= link_to "Previous", admin_events_path(page: pagination_current_page - 1, filter: @filter), class: "page-link" %>
          </li>
        <% else %>
          <li class="page-item disabled">
            <span class="page-link">Previous</span>
          </li>
        <% end %>

        <% page_start = [pagination_current_page - 2, 1].max %>
        <% page_end = [page_start + 4, pagination_total_pages].min %>
        <% page_start = [page_end - 4, 1].max if page_end - page_start < 4 %>

        <% (page_start..page_end).each do |page| %>
          <% if page == pagination_current_page %>
            <li class="page-item active">
              <span class="page-link"><%= page %></span>
            </li>
          <% else %>
            <li class="page-item">
              <%= link_to page, admin_events_path(page: page, filter: @filter), class: "page-link" %>
            </li>
          <% end %>
        <% end %>

        <% if pagination_current_page < pagination_total_pages %>
          <li class="page-item">
            <%= link_to "Next", admin_events_path(page: pagination_current_page + 1, filter: @filter), class: "page-link" %>
          </li>
        <% else %>
          <li class="page-item disabled">
            <span class="page-link">Next</span>
          </li>
        <% end %>
      </ul>

      <div class="text-center text-muted">
        Showing <%= @events.size %> of <%= pagination_total_count %> events
      </div>
    </nav>
  <% end %>
<% else %>
  <div class="card">
    <div class="card-body text-center py-5 text-muted">
      <h4>No events found</h4>
      <p>Events will appear here as they are created.</p>
    </div>
  </div>
<% end %>
