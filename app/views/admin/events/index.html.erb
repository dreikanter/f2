<% content_for :title, "Events" %>

<%= page_header "Events" do %>
  <% if @filter.present? %>
    <%= link_to "Reset Filter", admin_events_path, class: "btn btn-outline-secondary btn-sm" %>
  <% end %>
<% end %>

<% if @events.any? %>
  <div class="table-responsive">
    <table class="table table-hover table-bordered">
      <thead>
        <tr>
          <th>Type</th>
          <th class="text-center">Lvl</th>
          <th>Message</th>
          <th>User</th>
          <th>Subject</th>
          <th class="text-center"><i class="bi bi-calendar-event"></i></th>
        </tr>
      </thead>
      <tbody>
        <% @events.each do |event| %>
          <tr>
            <td>
              <%= link_to admin_events_path(filter: { type: event.type }),
                          class: "text-decoration-none",
                          title: "Filter by type: #{event.type}" do %>
                <code><%= event.type %></code>
              <% end %>
            </td>
            <td class="text-center">
              <%= level_badge(event.level) %>
            </td>
            <td>
              <div class="text-truncate" style="max-width: 300px;">
                <%= event.message.present? ? event.message : content_tag(:em, "No message", class: "text-muted") %>
              </div>
            </td>
            <td>
              <%= event.user&.email_address || content_tag(:em, "System", class: "text-muted") %>
            </td>
            <td>
              <% if event.subject %>
                <%= link_to admin_events_path(filter: { subject_type: event.subject_type }),
                            class: "text-decoration-none text-muted",
                            title: "Filter by subject type: #{event.subject_type}" do %>
                  <%= event.subject_type %>
                <% end %>
                <span class="text-primary">#<%= event.subject_id %></span>
              <% else %>
                <em class="text-muted">None</em>
              <% end %>
            </td>
            <td class="text-center">
              <span class="text-muted" title="<%= event.created_at.rfc3339 %>">
                <%= short_time_ago(event.created_at) %>
              </span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <%= pagination_for @events,
                     collection_name: "events",
                     path_helper: ->(page) { admin_events_path(page: page, filter: @filter) } %>
<% else %>
  <div class="card">
    <div class="card-body text-center py-5 text-muted">
      <h4>No events found</h4>
      <p>Events will appear here as they are created.</p>
    </div>
  </div>
<% end %>
