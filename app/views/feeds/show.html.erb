<% content_for :title, @feed.name %>

<div class="space-y-10">
  <%= render PageHeaderComponent.new(title: @feed.name) do |header| %>
    <% if (status_summary = feed_status_summary(@feed)).present? %>
      <% header.with_context_paragraph(status_summary) %>
    <% end %>
    <% if @feed.enabled? %>
      <% header.with_action_button do %>
        <%= button_to "Disable",
                      feed_status_path(@feed),
                      method: :patch,
                      params: { status: "disabled" },
                      data: { turbo_confirm: "Disable this feed?" },
                      class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                      form: { class: "inline-block" } %>
      <% end %>
    <% elsif @feed.can_be_enabled? %>
      <% header.with_action_button do %>
        <%= button_to "Enable",
                      feed_status_path(@feed),
                      method: :patch,
                      params: { status: "enabled" },
                      class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                      form: { class: "inline-block" } %>
      <% end %>
    <% else %>
      <% header.with_action_button do %>
        <span class="ff-button ff-button--secondary ff-button--compact cursor-not-allowed opacity-60" title="Complete setup to enable this feed">Enable</span>
      <% end %>
    <% end %>
    <% if @feed.can_be_previewed? %>
      <% header.with_action_button do %>
        <%= button_to "Preview",
                      feed_previews_path,
                      params: { url: @feed.url, feed_profile_key: @feed.feed_profile_key },
                      method: :post,
                      class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                      data: { turbo: false },
                          form: { class: "inline-block" } %>
      <% end %>
    <% else %>
      <% header.with_action_button do %>
        <span class="ff-button ff-button--secondary ff-button--compact cursor-not-allowed opacity-60" title="Preview requires feed URL and profile">Preview</span>
      <% end %>
    <% end %>
  <% end %>

  <section class="space-y-4">
    <h2 class="ff-h2">Stats</h2>
    <%= render FeedStatsComponent.new(feed: @feed) %>
  </section>

  <section class="space-y-4">
    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <h2 class="ff-h2 mb-0">Recent posts</h2>
      <% if @recent_posts.any? %>
        <%= link_to "View all posts", posts_path(feed_id: @feed.id), class: "ff-link text-sm" %>
      <% end %>
    </div>

    <%= render PostsListComponent.new(posts: @recent_posts, show_feed: false, empty_text: "No posts imported yet from this feed.") %>
  </section>

  <section class="space-y-4">
    <h2 class="ff-h2">Danger zone</h2>
    <div class="flex gap-2">
      <% if @feed.target_group.present? %>
        <%= link_to "Purge feed...", "#", class: "ff-button ff-button--secondary ff-button--compact", data: { controller: "modal-trigger", modal_trigger_modal_id_value: "purge-modal-#{@feed.id}", action: "click->modal-trigger#open" } %>
      <% end %>
      <%= link_to "Delete feed...", "#", class: "ff-button ff-button--secondary ff-button--compact", data: { controller: "modal-trigger", modal_trigger_modal_id_value: "delete-feed-modal-#{@feed.id}", action: "click->modal-trigger#open" } %>
    </div>
  </section>
</div>

<% if @feed.target_group.present? %>
  <%= render ConfirmationModalComponent.new(
    title: "Confirm Purge",
    action: "Purge all posts",
    url: feed_purge_path(@feed),
    method: :post,
    modal_id: "purge-modal-#{@feed.id}"
  ) do %>
    <div class="ff-alert ff-alert--warning">
      <p>This can't be undone. Every published post in <%= @feed.target_group %> will be withdrawn on FreeFeed. They'll remain visible in Feeder but can't be restored publicly.</p>
    </div>
  <% end %>
<% end %>

<%= render ConfirmationModalComponent.new(
  title: "Delete Feed",
  action: "Delete feed",
  url: feed_path(@feed),
  method: :delete,
  modal_id: "delete-feed-modal-#{@feed.id}"
) do %>
  <div class="ff-alert ff-alert--warning">
    <p>This can't be undone. This feed will be permanently removed from Feeder. All configuration and history will be lost.</p>
  </div>
<% end %>
