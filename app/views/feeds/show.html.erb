<% content_for :title, @feed.name %>

<div class="space-y-10">
  <%= render PageHeaderComponent.new(title: @feed.name) do |header| %>
    <% if (status_summary = feed_status_summary(@feed)).present? %>
      <% header.with_context_paragraph(status_summary) %>
    <% end %>
    <% if @feed.enabled? %>
      <% header.with_action_button do %>
        <%= button_to "Disable",
                      feed_status_path(@feed),
                      method: :patch,
                      params: { status: "disabled" },
                      data: { turbo_confirm: "Disable this feed?" },
                      class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                      form: { class: "inline-block" } %>
      <% end %>
    <% elsif @feed.can_be_enabled? %>
      <% header.with_action_button do %>
        <%= button_to "Enable",
                      feed_status_path(@feed),
                      method: :patch,
                      params: { status: "enabled" },
                      class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                      form: { class: "inline-block" } %>
      <% end %>
    <% else %>
      <% header.with_action_button do %>
        <span class="ff-button ff-button--secondary ff-button--compact cursor-not-allowed opacity-60" title="Complete setup to enable this feed">Enable</span>
      <% end %>
    <% end %>
    <% if @feed.can_be_previewed? %>
      <% header.with_action_button do %>
        <%= button_to "Preview",
                      feed_previews_path,
                      params: { url: @feed.url, feed_profile_key: @feed.feed_profile_key },
                      method: :post,
                      class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                      data: { turbo: false },
                          form: { class: "inline-block" } %>
      <% end %>
    <% else %>
      <% header.with_action_button do %>
        <span class="ff-button ff-button--secondary ff-button--compact cursor-not-allowed opacity-60" title="Preview requires feed URL and profile">Preview</span>
      <% end %>
    <% end %>
  <% end %>

  <section class="space-y-4">
    <h2 class="ff-h2">Stats</h2>
    <%= render FeedStatsComponent.new(feed: @feed) %>
  </section>

  <section class="space-y-4">
    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <h2 class="ff-h2 mb-0">Recent posts</h2>
      <% if @recent_posts.any? %>
        <%= link_to "View all posts", posts_path(feed_id: @feed.id), class: "ff-link text-sm" %>
      <% end %>
    </div>

    <%= render PostsListComponent.new(posts: @recent_posts, show_feed: false, empty_text: "No posts imported yet from this feed.") %>
  </section>

  <section class="space-y-3">
    <h2 class="ff-h2">Danger zone</h2>
    <div class="space-y-4 text-slate-600">
      <% if @feed.target_group.present? %>
        <div class="space-y-1">
          <p><%= link_to "Purge feed content...", "#", data: { action: "click->confirmation-modal#show" }, class: "font-semibold text-slate-900 transition ff-focus-ring" %></p>
          <p class="ff-text text-slate-600">Deletes all posts published to FreeFeed group <strong><%= @feed.target_group %></strong>.</p>
        </div>
        <%= render ConfirmationModalComponent.new(
          title: "Confirm Purge",
          explanation: "Every published post in #{@feed.target_group} will be withdrawn on FreeFeed. They'll remain visible in Feeder but can't be restored publicly.",
          confirm_text: "Purge all posts",
          confirm_url: feed_purge_path(@feed),
          method: :post,
          modal_id: "purge-modal-#{@feed.id}"
        ) %>
      <% end %>
      <div class="space-y-1">
        <p><%= link_to "Delete feed...", "#", data: { action: "click->confirmation-modal#show" }, class: "font-semibold text-slate-900 transition ff-focus-ring" %></p>
        <p class="ff-text text-slate-600">Disable and permanently remove the feed configuration from Feeder.</p>
      </div>
      <%= render ConfirmationModalComponent.new(
        title: "Delete Feed",
        explanation: "This feed will be permanently removed from Feeder. All configuration and history will be lost.",
        confirm_text: "Delete feed",
        confirm_url: feed_path(@feed),
        method: :delete,
        modal_id: "delete-feed-modal-#{@feed.id}"
      ) %>
    </div>
  </section>
</div>
