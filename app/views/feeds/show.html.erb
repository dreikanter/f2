<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="mb-0"><%= @feed.name %></h1>
  <div class="d-flex gap-2 align-items-center">
    
    <% if @feed.enabled? %>
      <div class="d-flex align-items-center me-2">
        <i class="bi bi-play-circle-fill text-success me-1"></i>
        <span class="text-success fw-medium">Enabled</span>
      </div>
      <%= button_to "Disable", feed_status_path(@feed),
          method: :patch,
          params: { status: "disabled" },
          data: { confirm: "Are you sure you want to disable this feed?" },
          class: "btn btn-outline-secondary" %>
    <% elsif @feed.can_be_enabled? %>
      <div class="d-flex align-items-center">
        <i class="bi bi-pause-circle-fill text-muted me-1"></i>
        <span class="text-muted fw-medium">Disabled</span>
      </div>
      <%= button_to "Enable", feed_status_path(@feed),
          method: :patch,
          params: { status: "enabled" },
          class: "btn btn-outline-success" %>
    <% else %>
      <div class="d-flex align-items-center me-2">
        <i class="bi bi-pause-circle-fill text-muted me-1"></i>
        <span class="text-muted fw-medium">Disabled</span>
      </div>
      <% missing_parts = feed_missing_enablement_parts(@feed) %>
      <span class="btn btn-outline-secondary disabled" title="Cannot enable without <%= missing_parts.join(' and ') %>">Enable</span>
    <% end %>
    
    <%= link_to "Edit", edit_feed_path(@feed), class: "btn btn-outline-secondary" %>
    <%= link_to "Delete", @feed, data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this feed?" }, class: "btn btn-outline-danger" %>
  </div>
</div>

<% if @feed.access_token.nil? %>
  <div class="alert alert-warning mb-4" role="alert">
    <strong>No access token assigned.</strong>
    This feed cannot process items without a working access token.
    <%= link_to "Edit feed", edit_feed_path(@feed), class: "alert-link" %> to assign one.
  </div>
<% elsif !@feed.access_token.active? %>
  <div class="alert alert-danger mb-4" role="alert">
    <strong>Access token is inactive.</strong>
    This feed cannot process items because the assigned token is no longer working.
    <%= link_to "Edit feed", edit_feed_path(@feed), class: "alert-link" %> to fix this.
  </div>
<% end %>

<% if @feed.disabled? && !@feed.can_be_enabled? %>
  <div class="alert alert-warning mb-4" role="alert">
    <strong>Feed cannot be enabled.</strong>
    <% missing_parts = feed_missing_enablement_parts(@feed) %>
    This feed is missing: <%= missing_parts.join(' and ') %>.
    <%= link_to "Edit feed", edit_feed_path(@feed), class: "alert-link" %> to configure the required settings.
  </div>
<% end %>

<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Feed Details</h5>
  </div>
  <div class="card-body">
    <% if @feed.description.present? %>
      <dl class="row">
        <dt class="col-12">Description</dt>
        <dd class="col-12">
          <%= simple_format(@feed.description, class: "mb-0") %>
        </dd>
      </dl>
    <% end %>

    <dl class="row mb-0">
      <dt class="col-lg-2 col-md-3">Feed URL</dt>
      <dd class="col-lg-4 col-md-9">
        <a href="<%= @feed.url %>" target="_blank" class="text-decoration-none">
          <%= @feed.url %>
        </a>
      </dd>

      <dt class="col-lg-2 col-md-3">Schedule</dt>
      <dd class="col-lg-4 col-md-9">
        <code class="text-dark fs-6"><%= @feed.cron_expression %></code>
      </dd>

      <dt class="col-lg-2 col-md-3">Next Run</dt>
      <dd class="col-lg-4 col-md-9">
        <%= @feed.feed_schedule&.next_run_at&.to_fs(:long) || "Not scheduled" %>
      </dd>

      <dt class="col-lg-2 col-md-3">Last Run</dt>
      <dd class="col-lg-4 col-md-9">
        <%= @feed.feed_schedule&.last_run_at&.to_fs(:long) || "Never" %>
      </dd>

      <dt class="col-lg-2 col-md-3">Feed Profile</dt>
      <dd class="col-lg-4 col-md-9">
        <% if @feed.feed_profile %>
          <%= @feed.feed_profile.name %>
          <small class="text-muted">(loader: <%= @feed.feed_profile.loader %>, processor: <%= @feed.feed_profile.processor %>, normalizer: <%= @feed.feed_profile.normalizer %>)</small>
        <% else %>
          <span class="text-muted">No profile configured</span>
        <% end %>
      </dd>

      <dt class="col-lg-2 col-md-3">Freefeed Host</dt>
      <dd class="col-lg-4 col-md-9">
        <% if @feed.access_token %>
          <%= @feed.access_token.host %>
        <% else %>
          <span class="text-muted">No host configured</span>
        <% end %>
      </dd>

      <dt class="col-lg-2 col-md-3">Access Token</dt>
      <dd class="col-lg-4 col-md-9">
        <% if @feed.access_token %>
          <%= @feed.access_token.name %>
        <% else %>
          <span class="text-muted">No token assigned</span>
        <% end %>
      </dd>

      <dt class="col-lg-2 col-md-3">Token Status</dt>
      <dd class="col-lg-4 col-md-9">
        <% if @feed.access_token %>
          <span class="badge bg-<%= @feed.access_token.active? ? 'success' : 'danger' %>">
            <%= @feed.access_token.status.capitalize %>
          </span>
        <% else %>
          <span class="text-muted">No status available</span>
        <% end %>
      </dd>

      <dt class="col-lg-2 col-md-3">Target Group</dt>
      <dd class="col-lg-4 col-md-9">
        <% if @feed.target_group.present? %>
          <%= @feed.target_group %>
        <% else %>
          <span class="text-muted">No target group assigned</span>
        <% end %>
      </dd>

      <% if @feed.import_after %>
        <dt class="col-lg-2 col-md-3">Import After</dt>
        <dd class="col-lg-4 col-md-9"><%= @feed.import_after.to_fs(:long) %></dd>
      <% end %>
    </dl>
  </div>
</div>
