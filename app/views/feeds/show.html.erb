<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><%= @feed.name %></h1>
  <div class="d-flex gap-2">
    <span class="badge bg-<%= @feed.enabled? ? 'success' : 'danger' %> fs-6">
      <%= @feed.state.capitalize %>
    </span>
    
    <% if @feed.enabled? %>
      <%= link_to "Disable", feed_path(@feed), 
          data: { turbo_method: :patch, turbo_confirm: "Are you sure you want to disable this feed?" },
          params: { feed: { state: :disabled } },
          class: "btn btn-outline-warning" %>
    <% elsif @feed.access_token&.active? %>
      <%= link_to "Enable", feed_path(@feed), 
          data: { turbo_method: :patch },
          params: { feed: { state: :enabled } },
          class: "btn btn-outline-success" %>
    <% else %>
      <span class="btn btn-outline-success disabled" title="Cannot enable without active access token">Enable</span>
    <% end %>
    
    <%= link_to "Edit", edit_feed_path(@feed), class: "btn btn-outline-primary" %>
    <%= link_to "Delete", @feed, data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this feed?" }, class: "btn btn-outline-danger" %>
  </div>
</div>

<% if @feed.access_token.nil? %>
  <div class="alert alert-warning mb-4" role="alert">
    <strong>No access token assigned.</strong>
    This feed cannot process items without a working access token. 
    <%= link_to "Edit feed", edit_feed_path(@feed), class: "alert-link" %> to assign one.
  </div>
<% elsif !@feed.access_token.active? %>
  <div class="alert alert-danger mb-4" role="alert">
    <strong>Access token is inactive.</strong>
    This feed cannot process items because the assigned token is no longer working. 
    <%= link_to "Edit feed", edit_feed_path(@feed), class: "alert-link" %> to fix this.
  </div>
<% end %>

<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Feed Details</h5>
  </div>
  <div class="card-body">
    <% if @feed.description.present? %>
      <dl class="row">
        <dt class="col-12">Description</dt>
        <dd class="col-12">
          <%= simple_format(@feed.description, class: "mb-0") %>
        </dd>
      </dl>
    <% end %>

    <dl class="row">
      <dt class="col-lg-2 col-md-3">Feed URL</dt>
      <dd class="col-lg-4 col-md-9">
        <a href="<%= @feed.url %>" target="_blank" class="text-decoration-none">
          <%= @feed.url %>
        </a>
      </dd>

      <dt class="col-lg-2 col-md-3">Schedule</dt>
      <dd class="col-lg-4 col-md-9">
        <code class="text-dark fs-6"><%= @feed.cron_expression %></code>
      </dd>

      <dt class="col-lg-2 col-md-3">Next Run</dt>
      <dd class="col-lg-4 col-md-9">
        <%= @feed.feed_schedule&.next_run_at&.to_fs(:long) || "Not scheduled" %>
      </dd>

      <dt class="col-lg-2 col-md-3">Last Run</dt>
      <dd class="col-lg-4 col-md-9">
        <%= @feed.feed_schedule&.last_run_at&.to_fs(:long) || "Never" %>
      </dd>

      <dt class="col-lg-2 col-md-3">Loader</dt>
      <dd class="col-lg-4 col-md-9"><%= @feed.loader %></dd>

      <dt class="col-lg-2 col-md-3">Processor</dt>
      <dd class="col-lg-4 col-md-9"><%= @feed.processor %></dd>

      <dt class="col-lg-2 col-md-3">Normalizer</dt>
      <dd class="col-lg-4 col-md-9"><%= @feed.normalizer %></dd>

      <dt class="col-lg-2 col-md-3">Access Token</dt>
      <dd class="col-lg-4 col-md-9">
        <% if @feed.access_token %>
          <%= @feed.access_token.name %> (<%= @feed.access_token.host %>)
          <span class="badge bg-<%= @feed.access_token.active? ? 'success' : 'danger' %> ms-2">
            <%= @feed.access_token.status.capitalize %>
          </span>
        <% else %>
          <span class="text-muted">No token assigned</span>
        <% end %>
      </dd>

      <% if @feed.import_after %>
        <dt class="col-lg-2 col-md-3">Import After</dt>
        <dd class="col-lg-4 col-md-9"><%= @feed.import_after.to_fs(:long) %></dd>
      <% end %>
    </dl>
  </div>
</div>
