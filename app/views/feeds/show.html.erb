<% content_for :title, @feed.name %>

<div class="space-y-10">
  <header class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
    <div class="space-y-2">
      <div class="flex items-center gap-3">
        <span class="inline-flex shrink-0 text-slate-500">
          <%= feed_status_icon(@feed) %>
        </span>
        <h1 id="feed-title" class="ff-h1 mb-0 text-slate-900"><%= @feed.name %></h1>
      </div>
      <% if (status_summary = feed_status_summary(@feed)).present? %>
        <p class="ff-text text-slate-600"><%= status_summary %></p>
      <% end %>
    </div>

    <div class="flex flex-wrap items-center gap-3">
      <% if @feed.enabled? %>
        <%= button_to "Disable",
                      feed_status_path(@feed),
                      method: :patch,
                      params: { status: "disabled" },
                      data: { turbo_confirm: "Disable this feed?" },
                      class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                      form: { class: "inline-block" } %>
      <% elsif @feed.can_be_enabled? %>
        <%= button_to "Enable",
                      feed_status_path(@feed),
                      method: :patch,
                      params: { status: "enabled" },
                      class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                      form: { class: "inline-block" } %>
      <% else %>
        <span class="ff-button ff-button--secondary ff-button--compact cursor-not-allowed opacity-60" title="Complete setup to enable this feed">Enable</span>
      <% end %>

      <% if @feed.can_be_previewed? %>
        <%= button_to "Preview",
                      feed_previews_path,
                      params: { url: @feed.url, feed_profile_key: @feed.feed_profile_key },
                      method: :post,
                      class: class_names("ff-button", "ff-button--secondary", "ff-button--compact"),
                      data: { turbo: false },
                      form: { class: "inline-block" } %>
      <% else %>
        <span class="ff-button ff-button--secondary ff-button--compact cursor-not-allowed opacity-60" title="Preview requires feed URL and profile">Preview</span>
      <% end %>
    </div>
  </header>

  <section class="space-y-4">
    <h2 class="ff-h2">Stats</h2>
    <div class="ff-stats">
      <div class="ff-stats__row">
        <span class="ff-stats__label">Last refresh:</span>
        <span class="ff-stats__value">
          <%= @feed.last_refreshed_at ? time_ago_tag(@feed.last_refreshed_at) : content_tag(:span, "Never", class: "text-slate-500") %>
        </span>
      </div>

      <div class="ff-stats__row">
        <span class="ff-stats__label">Most recent post:</span>
        <span class="ff-stats__value">
          <%= @feed.most_recent_post_date ? time_ago_tag(@feed.most_recent_post_date) : content_tag(:span, "No posts imported", class: "text-slate-500") %>
        </span>
      </div>

      <div class="ff-stats__row">
        <span class="ff-stats__label">Imported posts:</span>
        <span class="ff-stats__value"><%= number_with_delimiter(@feed.posts.count) %></span>
      </div>

      <div class="ff-stats__row">
        <span class="ff-stats__label">Published posts:</span>
        <span class="ff-stats__value"><%= number_with_delimiter(@feed.posts.published.count) %></span>
      </div>
    </div>
  </section>

  <section class="space-y-4">
    <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <h2 class="ff-h2 mb-0">Recent posts</h2>
      <% if @recent_posts.any? %>
        <%= link_to "View all posts", posts_path(feed_id: @feed.id), class: "ff-link text-sm" %>
      <% end %>
    </div>

    <% if @recent_posts.any? %>
      <ul class="divide-y divide-slate-200 overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm">
        <% @recent_posts.each do |post| %>
          <%= render "feeds/recent_post", post: post %>
        <% end %>
      </ul>
    <% else %>
      <p class="ff-text text-slate-500">No posts imported yet from this feed.</p>
    <% end %>
  </section>

  <section class="space-y-3">
    <h2 class="ff-h2">Danger zone</h2>
    <div class="space-y-4 text-slate-600">
      <% if @feed.target_group.present? %>
        <div class="space-y-1">
          <p><%= link_to "Purge feed content...", feed_purge_path(@feed), class: "font-semibold text-slate-900 transition ff-focus-ring" %></p>
          <p class="ff-text text-slate-600">Deletes all posts published to FreeFeed group <strong><%= @feed.target_group %></strong>.</p>
        </div>
      <% end %>
      <div class="space-y-1">
        <%# TBD: Add a confirmation page here %>
        <p><%= link_to "Delete feed...", @feed, data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this feed? This cannot be undone." }, class: "font-semibold text-slate-900 transition ff-focus-ring" %></p>
        <p class="ff-text text-slate-600">Disable and permanently remove the feed configuration from Feeder.</p>
      </div>
    </div>
  </section>
</div>
