<%# locals: (feed:) %>
<div data-controller="groups"
     data-groups-loading-text-value="Loading..."
     data-groups-default-text-value="Select the Freefeed group where posts will be published">
<%= form_with model: feed, local: true, class: "needs-validation", novalidate: true do |form| %>
  <% if feed.errors.any? %>
    <div class="alert alert-danger">
      <h6><%= pluralize(feed.errors.count, "error") %> occurred:</h6>
      <ul class="mb-0">
        <% feed.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= form.label :access_token_id, "Access Token", class: "form-label" %>
    <%= form.select :access_token_id, options_for_select(access_token_options, feed.access_token_id),
                    { prompt: "Choose access token..." },
                    { class: "form-select",
                      data: { action: "change->groups#refresh" } } %>
    <div class="form-text">Select the Freefeed access token to use for posting</div>
    <div class="invalid-feedback">Please select an access token.</div>

    <% unless has_active_tokens? %>
      <div class="alert alert-warning mt-2" role="alert">
        <strong>No active tokens available.</strong>
        You won't be able to enable this feed later without selecting a working token.
      </div>
    <% end %>
  </div>

  <div class="mb-3">
    <%= form.label :target_group, "Target Group", class: "form-label" %>
    <div id="groups-select">
      <select name="feed[target_group]"
              id="feed_target_group"
              class="form-select"
              disabled
              data-groups-target="select">
        <option value="<%= feed.target_group %>"><%= feed.target_group.present? ? feed.target_group : "Choose target group..." %></option>
      </select>
      <div class="form-text" data-groups-target="helpText">
        Select the Freefeed group where posts will be published
      </div>
      <div class="invalid-feedback">Please select a target group.</div>
    </div>
  </div>

  <div class="d-flex gap-2">
    <%= form.submit "Save Reposting Configuration", class: "btn btn-primary" %>
    <%= link_to "Cancel", feed_path(feed, section: "reposting", format: :turbo_stream),
        class: "btn btn-outline-secondary",
        data: { turbo_prefetch: false } %>
  </div>
<% end %>
</div>